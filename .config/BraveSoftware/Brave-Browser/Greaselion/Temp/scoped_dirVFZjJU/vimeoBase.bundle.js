(()=>{"use strict";const e="mnojpmjdmbbfmejpflffifhffcmidifd";let t=null;const r=()=>t,n=(e,t)=>e&&t?`${e}_${t}`:"",i=(e,t)=>`${e}#channel:${t}`,o=(e,t,r)=>{if(e.length<t.length)return"";const n=e.indexOf(t);if(-1===n)return"";const i=n+t.length,o=e.indexOf(r,i);let a="";return o!==i?a=-1!==o&&o>i||-1!==o?e.substring(i,o):e.substring(i):""===r&&(a=e.substring(i)),a},a=()=>"complete"===document.readyState&&"visible"===document.visibilityState,s=(e,t)=>`${e}: ${t.statusText} (${t.status})`,c=(RegExp(/&(?:amp|lt|gt|quot|#(0+)?39);/g.source),"vimeo"),l="vimeo.com",u=e=>{if(!e)return"";const t=o(e,'"display_name":"','"');if(!t)return"";let r=null;try{r=JSON.parse(`{"brave_publisher":"${t}"}`)}catch(e){throw new Error(`Error parsing publisher name from video page: ${e}`)}return r.brave_publisher},h=e=>{if(!e)return"";let t=o(e,'<meta property="al:ios:url" content="vimeo://app.vimeo.com/users/','"');return t||(t=o(e,'<meta property="al:android:url" content="vimeo://app.vimeo.com/users/','"'),t||o(e,'<link rel="canonical" href="/','"'))},p=async()=>{const e=location.href,t=await fetch(e);if(!t.ok){const e=s("Publisher request failed",t);throw new Error(e)}const r=await t.text();if(!r)throw new Error("Publisher response empty");let a="",l="",p=h(r);if(p)a=(e=>{if(!e)return"";return u(e)||o(e,'<meta property="og:title" content="','"')})(r),a||(a=p);else{if(a=u(r),!a)throw new Error("Invalid publisher name");if(p=(e=>e?o(e,'"creator_id":',","):"")(r),!p)throw new Error("Invalid user id");const e=(e=>e?o(e,'<link rel="canonical" href="https://vimeo.com/','"'):"")(r);if(!e)throw new Error("Invalid video id")}return l=n(c,p),{url:e,publisherKey:i(c,p),publisherName:a,mediaKey:l,favIconUrl:""}},d=()=>{(e=>{if(!e)return!1;const t=["/","/about","/blog","/enterprise","/help","/jobs","/live","/log_in","/ondemand","/ott","/purchases","/search","/settings","/site_map","/stats","/stock","/upgrade","/upload","/videoschool","/watch","/watchlater"];if(t.includes(e)||t.includes(e+"/"))return!0;if(e.startsWith("/channels/staffpicks/"))return!1;const r=["/blog/","/categories/","/channels/","/features/","/help/","/manage/","/ott/","/settings/","/solutions/","/stock/"];for(const t of r)if(e.startsWith(t))return!0;return!1})(new URL(location.href).pathname)?(()=>{const e=`https://${l}`,t=l,n=l,i=r();i&&i.postMessage({type:"SavePublisherVisit",mediaType:"",data:{url:e,publisherKey:t,publisherName:n,favIconUrl:""}})})():m().then((e=>{const t=r();if(!t)throw new Error("Invalid port");t.postMessage({type:"SavePublisherVisit",mediaType:c,data:{url:e.url,publisherKey:e.publisherKey,publisherName:e.publisherName,mediaKey:e.mediaKey,favIconUrl:e.favIconUrl}})})).catch((e=>{throw new Error(`Failed to retrieve publisher data: ${e}`)}))},m=async()=>{return(e=location.pathname)&&/^\/\d+$/.test(e)?(async()=>{const e=location.href,t=encodeURI(e),r=await fetch(`https://vimeo.com/api/oembed.json?url=${t}`);if(!r.ok)return p();const o=await r.json();if(!o)return p();const a=o.author_url;if(!a)return p();const l=o.author_name;if(!l)throw new Error("Invalid publisher name");const u=o.video_id;if(!u||0===u)return p();const d=await fetch(a);if(!d.ok){const e=s("Publisher request failed",d);throw new Error(e)}const m=await d.text(),f=h(m);if(!f)throw new Error("Invalid user id");const b=i(c,f),v=n(c,u.toString());if(!v)throw new Error("Invalid media key");const w=(e=>e?`https://i.vimeocdn.com/portrait/${e}_300x300.webp`:"")(f);return{url:a,publisherKey:b,publisherName:l,mediaKey:v,favIconUrl:w}})():p();var e};let f=!1,b="";const v=e=>{e&&(e.url||"complete"===e.status)&&location.href!==b&&(b=location.href,d())};var w;chrome.extension.inIncognitoContext||(w=e=>{e?(a()?d():document.addEventListener("readystatechange",(function(){a()&&setTimeout((()=>{d()}),200)})),document.addEventListener("visibilitychange",(function(){"visible"===document.visibilityState&&d()})),((e,t)=>{if(!e||f)return;f=!0;const n=r();n&&(n.postMessage({type:"RegisterOnUpdatedTab",mediaType:e}),n.onMessage.addListener((function(e){e.data&&"OnUpdatedTab"===e.type&&t(e.data.changeInfo)})))})(c,v)):console.error("Failed to initialize communications port")},t?w(!0):(chrome.runtime.sendMessage(e,{type:"SupportsGreaselion"},(function(r){!chrome.runtime.lastError&&r&&r.supported&&(t=chrome.runtime.connect(e,{name:"Greaselion"}),w(!0))})),setTimeout((()=>{t||(t=chrome.runtime.connect("jidkidbbcafjabdphckchenhfomhnfma",{name:"Greaselion"}),w(!0))}),100)),console.info("Greaselion script loaded: vimeo.ts"))})();